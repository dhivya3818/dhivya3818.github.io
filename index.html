<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <script type="text/javascript" src="connect-streams-min.js"></script>
  <script type="text/javascript" src="amazon-connect-chat.js"></script>
  <script src="aws-sdk.js"></script>
  <script type='text/javascript' src='config.js'></script>
</head>
<!-- Add the call to init() as an onload so it will only run once the page is loaded -->

<body onload="init()">
  <div id="container-div" style="width: 400px; height: 800px;"></div>
  <div id="agent-container-div" style="width: 400px; height: 800px;"></div>
  <script type="text/javascript">
    var containerDiv = document.getElementById("container-div");
    var agentContainerDiv = document.getElementById("agent-container-div");
    var instanceURL = "https://contact-centre-service.awsapps.com/connect/ccp-v2/";


    console.log("start of script");
    console.log(config.awsAccessKeyId);
    // require('dotenv').config();
    // console.log(process.env);
    AWS.config.region = 'eu-west-2';
    ep = new AWS.Endpoint('translate.eu-west-2.amazonaws.com');
    AWS.config.credentials = new AWS.Credentials(config.awsAccessKeyId, config.awsSecretAccessKey);
    // var DetectLanguage = require('detectlanguage');
    // window.alert("oj");
    console.log("under credentials");
    var text = "Hola, ¿cómo estás";
    window.translator = new AWS.Translate({ endpoint: ep, region: AWS.config.region });
    // window.alert(predictLanguage(text));
    // var detectlanguage = new DetectLanguage('c4311f30706c3934da48d02ecaeab86f');
    // detectlanguage.detect(text).then(function (result) {
    //   window.alert(JSON.stringify(result));
    // });

    var params = {
      Text: text,
      SourceLanguageCode: 'auto',
      TargetLanguageCode: 'en'
    };

    window.translator.translateText(params, function onSendMessageTranslate(err,
      data) {
      if (err) {
        console.log("translaatee eerooooooooooooorrrrrrr");
        console.log("Error calling Translate. " + err.message + err.stack);
      }
      if (data) {
        console.log("M: " + message);
        console.log("T: " + data.TranslatedText);
        //Send message to chat
        window.alert(data.TranslatedText);
      }
    });


    // initialize the streams api
    function init() {
      // initialize the ccp
      connect.core.initCCP(containerDiv, {
        ccpUrl: instanceURL,            // REQUIRED
        loginPopup: true,               // optional, defaults to `true`
        loginPopupAutoClose: true,      // optional, defaults to `false`
        loginOptions: {                 // optional, if provided opens login in new window
          autoClose: true,              // optional, defaults to `false`
          height: 600,                  // optional, defaults to 578
          width: 400,                   // optional, defaults to 433
          top: 0,                       // optional, defaults to 0
          left: 0                       // optional, defaults to 0
        },
        region: "eu-west-2",         // REQUIRED for `CHAT`, optional otherwise
        softphone: {                    // optional, defaults below apply if not provided
          allowFramedSoftphone: true,   // optional, defaults to false
          disableRingtone: false,       // optional, defaults to false
          ringtoneUrl: "./ringtone.mp3" // optional, defaults to CCP’s default ringtone if a falsy value is set
        },
        pageOptions: {                  // optional
          enableAudioDeviceSettings: false, // optional, defaults to 'false'
          enablePhoneTypeSettings: true // optional, defaults to 'true'
        }
      });

      // configuring ChatSession 
      connect.ChatSession.setGlobalConfig({
        region: "eu-west-2",
      });

      connect.contact(function (contact) {

        contact.onIncoming(function (contact) {
        });

        contact.onRefresh(async function (contact) {
          const cnn = contact.getConnections().find(cnn => cnn.getType() === window.connect.ConnectionType.AGENT);
          const agentChatSession = await cnn.getMediaController();

          const awsSdkResponse = await agentChatSession.getTranscript({
            maxResults: 5,
            sortOrder: "ASCENDING"
          });

          const { InitialContactId, NextToken, Transcript } = awsSdkResponse.data;

          console.warn(JSON.stringify(Transcript[Transcript.length - 1]["Content"]));

        });

        contact.onAccepted(function (contact) {
        });

        contact.onEnded(function () {
        });

        contact.onConnected(async function () {
          // testing retrieval of contact attribute
          console.log(`onConnected(${contact.getContactId()})`);
          var attributeMap = contact.getAttributes();
          var zip = JSON.stringify(attributeMap["zip"]["value"]);
          window.alert("Customer's zipcode: " + zip);

          // creating Agent Chat Session
          const cnn = contact.getConnections().find(cnn => cnn.getType() === window.connect.ConnectionType.AGENT);
          const agentChatSession = await cnn.getMediaController();

          // function getEvents(contact, agentChatSession) {
          //   contact.getAgentConnection().getMediaController().then(controller => {
          //     controller.onMessage(messageData => {
          //       if (messageData.chatDetails.participantId === messageData.data.ParticipantId) {
          //         console.log(`CDEBUG ===> Agent ${messageData.data.DisplayName} Says`,
          //           messageData.data.Content)
          //       }
          //       else {
          //         console.log(`CDEBUG ===> Customer ${messageData.data.DisplayName} Says`, messageData.data.Content);
          //         processChatText(messageData.data.Content, messageData.data.Type, messageData.data.ContactId);
          //       }
          //     })
          //   })
          // }

        });
      });


    }
  </script>
</body>

</html>
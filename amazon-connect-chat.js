!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=4)}([function(e,t,n){var o;!function(){"use strict";var r={not_string:/[^s]/,not_bool:/[^t]/,not_type:/[^T]/,not_primitive:/[^v]/,number:/[diefg]/,numeric_arg:/[bcdiefguxX]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijostTuvxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[+-]/};function i(e){return a(u(e),arguments)}function c(e,t){return i.apply(null,[e].concat(t||[]))}function a(e,t){var n,o,c,a,s,u,l,f,p,h=1,d=e.length,g="";for(o=0;o<d;o++)if("string"==typeof e[o])g+=e[o];else if("object"==typeof e[o]){if((a=e[o]).keys)for(n=t[h],c=0;c<a.keys.length;c++){if(null==n)throw new Error(i('[sprintf] Cannot access property "%s" of undefined value "%s"',a.keys[c],a.keys[c-1]));n=n[a.keys[c]]}else n=a.param_no?t[a.param_no]:t[h++];if(r.not_type.test(a.type)&&r.not_primitive.test(a.type)&&n instanceof Function&&(n=n()),r.numeric_arg.test(a.type)&&"number"!=typeof n&&isNaN(n))throw new TypeError(i("[sprintf] expecting number but found %T",n));switch(r.number.test(a.type)&&(f=n>=0),a.type){case"b":n=parseInt(n,10).toString(2);break;case"c":n=String.fromCharCode(parseInt(n,10));break;case"d":case"i":n=parseInt(n,10);break;case"j":n=JSON.stringify(n,null,a.width?parseInt(a.width):0);break;case"e":n=a.precision?parseFloat(n).toExponential(a.precision):parseFloat(n).toExponential();break;case"f":n=a.precision?parseFloat(n).toFixed(a.precision):parseFloat(n);break;case"g":n=a.precision?String(Number(n.toPrecision(a.precision))):parseFloat(n);break;case"o":n=(parseInt(n,10)>>>0).toString(8);break;case"s":n=String(n),n=a.precision?n.substring(0,a.precision):n;break;case"t":n=String(!!n),n=a.precision?n.substring(0,a.precision):n;break;case"T":n=Object.prototype.toString.call(n).slice(8,-1).toLowerCase(),n=a.precision?n.substring(0,a.precision):n;break;case"u":n=parseInt(n,10)>>>0;break;case"v":n=n.valueOf(),n=a.precision?n.substring(0,a.precision):n;break;case"x":n=(parseInt(n,10)>>>0).toString(16);break;case"X":n=(parseInt(n,10)>>>0).toString(16).toUpperCase()}r.json.test(a.type)?g+=n:(!r.number.test(a.type)||f&&!a.sign?p="":(p=f?"+":"-",n=n.toString().replace(r.sign,"")),u=a.pad_char?"0"===a.pad_char?"0":a.pad_char.charAt(1):" ",l=a.width-(p+n).length,s=a.width&&l>0?u.repeat(l):"",g+=a.align?p+n+s:"0"===u?p+s+n:s+p+n)}return g}var s=Object.create(null);function u(e){if(s[e])return s[e];for(var t,n=e,o=[],i=0;n;){if(null!==(t=r.text.exec(n)))o.push(t[0]);else if(null!==(t=r.modulo.exec(n)))o.push("%");else{if(null===(t=r.placeholder.exec(n)))throw new SyntaxError("[sprintf] unexpected placeholder");if(t[2]){i|=1;var c=[],a=t[2],u=[];if(null===(u=r.key.exec(a)))throw new SyntaxError("[sprintf] failed to parse named argument key");for(c.push(u[1]);""!==(a=a.substring(u[0].length));)if(null!==(u=r.key_access.exec(a)))c.push(u[1]);else{if(null===(u=r.index_access.exec(a)))throw new SyntaxError("[sprintf] failed to parse named argument key");c.push(u[1])}t[2]=c}else i|=2;if(3===i)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");o.push({placeholder:t[0],param_no:t[1],keys:t[2],sign:t[3],pad_char:t[4],align:t[5],width:t[6],precision:t[7],type:t[8]})}n=n.substring(t[0].length)}return s[e]=o}t.sprintf=i,t.vsprintf=c,"undefined"!=typeof window&&(window.sprintf=i,window.vsprintf=c,void 0===(o=function(){return{sprintf:i,vsprintf:c}}.call(t,n,t,e))||(e.exports=o))}()},function(e,t,n){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}function c(e){var t=l();return function(){var n,o=p(e);if(t){var r=p(this).constructor;n=Reflect.construct(o,arguments,r)}else n=o.apply(this,arguments);return a(this,n)}}function a(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function s(e){var t="function"==typeof Map?new Map:void 0;return(s=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,o)}function o(){return u(e,arguments,p(this).constructor)}return o.prototype=Object.create(e.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),f(o,e)})(e)}function u(e,t,n){return(u=l()?Reflect.construct:function(e,t,n){var o=[null];o.push.apply(o,t);var r=new(Function.bind.apply(e,o));return n&&f(r,n.prototype),r}).apply(null,arguments)}function l(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}n.d(t,"a",(function(){return yt}));var h=function(e){i(n,e);var t=c(n);function n(e){var o;return r(this,n),(o=t.call(this,e)).name="ValueError",console.log("EXCEPTION: "+o.name+" MESSAGE: "+o.message),o}return n}(s(Error)),d=function(e){i(n,e);var t=c(n);function n(e){var o;return r(this,n),(o=t.call(this,e)).name="UnImplementedMethod",console.log("EXCEPTION: "+o.name+" MESSAGE: "+o.message),o}return n}(s(Error)),g=function(e){i(n,e);var t=c(n);function n(e,o){var i;return r(this,n),(i=t.call(this,e)).name="IllegalArgument",i.argument=o,console.log("EXCEPTION: "+i.name+" MESSAGE: "+i.message),i}return n}(s(Error));Error,Error;function b(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var y=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,o;return t=e,(n=[{key:"update",value:function(e){var t=e||{};this.region=t.region||this.region,this.endpointOverride=t.endpoint||this.endpointOverride,this.reconnect=!1!==t.reconnect}},{key:"getRegion",value:function(){return this.region}},{key:"getEndpointOverride",value:function(){return this.endpointOverride}}])&&b(t.prototype,n),o&&b(t,o),e}()),v={AGENT:"AGENT",CUSTOMER:"CUSTOMER"},m="INCOMING_MESSAGE",k="INCOMING_TYPING",w="CONNECTION_ESTABLISHED",C="CONNECTION_LOST",S="CONNECTION_BROKEN",T="CHAT_ENDED",_={textPlain:"text/plain",textCsv:"text/csv",applicationDoc:"application/msword",applicationPdf:"application/pdf",applicationPpt:"application/vnd.ms-powerpoint",applicationXls:"application/vnd.ms-excel",imageJpg:"image/jpeg",imagePng:"image/png",audioWav:"audio/wav",connectionAcknowledged:"application/vnd.amazonaws.connect.event.connection.acknowledged",typing:"application/vnd.amazonaws.connect.event.typing",participantJoined:"application/vnd.amazonaws.connect.event.participant.joined",participantLeft:"application/vnd.amazonaws.connect.event.participant.left",transferSucceeded:"application/vnd.amazonaws.connect.event.transfer.succeeded",transferFailed:"application/vnd.amazonaws.connect.event.transfer.failed",chatEnded:"application/vnd.amazonaws.connect.event.chat.ended",interactiveMessage:"application/vnd.amazonaws.connect.message.interactive"},E=15,O="ASCENDING",I="BACKWARD",N="NULL",R="CLIENT_LOGGER",P="DEBUG",x="us-west-2",j=n(0);function M(e){return(M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var A={assertTrue:function(e,t){if(!e)throw new h(t)},assertNotNull:function(e,t){return A.assertTrue(null!==e&&void 0!==M(e),Object(j.sprintf)("%s must be provided",t||"A value")),e},now:function(){return(new Date).getTime()},isString:function(e){return"string"==typeof e},randomId:function(){return Object(j.sprintf)("%s-%s",A.now(),Math.random().toString(36).slice(2))},assertIsNonEmptyString:function(e,t){if(!e||"string"!=typeof e)throw new g(t+" is not a non-empty string!")},assertIsList:function(e,t){if(!Array.isArray(e))throw new g(t+" is not an array")},assertIsEnum:function(e,t,n){var o;for(o=0;o<t.length;o++)if(t[o]===e)return;throw new g(n+" passed ("+e+") is not valid. Allowed values are: "+t)},makeEnum:function(e){var t={};return e.forEach((function(e){var n=e.replace(/\.?([a-z]+)_?/g,(function(e,t){return t.toUpperCase()+"_"})).replace(/_$/,"");t[n]=e})),t},contains:function(e,t){return e instanceof Array?null!==A.find(e,(function(e){return e===t})):t in e},find:function(e,t){for(var n=0;n<e.length;n++)if(t(e[n]))return e[n];return null},containsValue:function(e,t){return e instanceof Array?null!==A.find(e,(function(e){return e===t})):null!==A.find(A.values(e),(function(e){return e===t}))},isFunction:function(e){return!!(e&&e.constructor&&e.call&&e.apply)},values:function(e){var t=[];for(var n in A.assertNotNull(e,"map"),e)t.push(e[n]);return t},isObject:function(e){return!("object"!==M(e)||null===e)},assertIsObject:function(e,t){if(!A.isObject(e))throw new g(t+" is not an object!")},delay:function(e){return new Promise((function(t){return setTimeout(t,e)}))},asyncWhileInterval:function(e,t,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=new Date;return t(o)?e(o).catch((function(r){var c=Math.max(0,n-(new Date).valueOf()+i.valueOf());return A.delay(c).then((function(){return A.asyncWhileInterval(e,t,n,o+1,r)}))})):Promise.reject(r||new Error("async while aborted"))},isAttachmentContentType:function(e){return e===_.applicationPdf||e===_.imageJpg||e===_.imagePng||e===_.applicationDoc||e===_.applicationXls||e===_.applicationPpt||e===_.textCsv||e===_.audioWav}},D=A;function L(e){return(L="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function W(e,t){return(W=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function F(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=B(e);if(t){var r=B(this).constructor;n=Reflect.construct(o,arguments,r)}else n=o.apply(this,arguments);return G(this,n)}}function G(e,t){return!t||"object"!==L(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function B(e){return(B=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function U(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function H(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function q(e,t,n){return t&&H(e.prototype,t),n&&H(e,n),e}var z=function(){function e(){U(this,e)}return q(e,[{key:"debug",value:function(e){}},{key:"info",value:function(e){}},{key:"warn",value:function(e){}},{key:"error",value:function(e){}}]),e}(),J={DEBUG:10,INFO:20,WARN:30,ERROR:40},X=function(){function e(){U(this,e),this.updateLoggerConfig(),this.consoleLoggerWrapper=K()}return q(e,[{key:"writeToClientLogger",value:function(e,t){if(this.hasClientLogger())switch(e){case J.DEBUG:return this._clientLogger.debug(t);case J.INFO:return this._clientLogger.info(t);case J.WARN:return this._clientLogger.warn(t);case J.ERROR:return this._clientLogger.error(t)}}},{key:"isLevelEnabled",value:function(e){return e>=this._level}},{key:"hasClientLogger",value:function(){return null!==this._clientLogger}},{key:"getLogger",value:function(e){var t=e.prefix||"";return this._logsDestination===P?this.consoleLoggerWrapper:new $(t)}},{key:"updateLoggerConfig",value:function(e){var t=e||{};this._level=t.level||J.INFO,this._clientLogger=t.logger||null,this._logsDestination=N,t.debug&&(this._logsDestination=P),t.logger&&(this._logsDestination=R)}}]),e}(),V=function(){function e(){U(this,e)}return q(e,[{key:"debug",value:function(){}},{key:"info",value:function(){}},{key:"warn",value:function(){}},{key:"error",value:function(){}}]),e}(),$=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&W(e,t)}(n,e);var t=F(n);function n(e){var o;return U(this,n),(o=t.call(this)).prefix=e||"",o}return q(n,[{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._log(J.DEBUG,t)}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._log(J.INFO,t)}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._log(J.WARN,t)}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._log(J.ERROR,t)}},{key:"_shouldLog",value:function(e){return Y.hasClientLogger()&&Y.isLevelEnabled(e)}},{key:"_writeToClientLogger",value:function(e,t){Y.writeToClientLogger(e,t)}},{key:"_log",value:function(e,t){if(this._shouldLog(e)){var n=this._convertToSingleStatement(t);this._writeToClientLogger(e,n)}}},{key:"_convertToSingleStatement",value:function(e){var t="";this.prefix&&(t+=this.prefix+" ");for(var n=0;n<e.length;n++){var o=e[n];t+=this._convertToString(o)+" "}return t}},{key:"_convertToString",value:function(e){try{if(!e)return"";if(D.isString(e))return e;if(D.isObject(e)&&D.isFunction(e.toString)){var t=e.toString();if("[object Object]"!==t)return t}return JSON.stringify(e)}catch(t){return console.error("Error while converting argument to string",e,t),""}}}]),n}(V),K=function(){var e=new V;return e.debug=console.debug.bind(window.console),e.info=console.info.bind(window.console),e.warn=console.warn.bind(window.console),e.error=console.error.bind(window.console),e},Y=new X;function Q(e){return(Q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Z(e,t){return(Z=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ee(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=ne(e);if(t){var r=ne(this).constructor;n=Reflect.construct(o,arguments,r)}else n=o.apply(this,arguments);return te(this,n)}}function te(e,t){return!t||"object"!==Q(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ne(e){return(ne=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function oe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function re(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function ie(e,t,n){return t&&re(e.prototype,t),n&&re(e,n),e}var ce=function(){function e(){oe(this,e),this.clientCache={}}return ie(e,[{key:"getCachedClient",value:function(e){var t=Object.assign({},e),n=e.region||y.getRegion()||x;if(t.region=n,this.clientCache[n])return this.clientCache[n];var o=this._createAwsClient(t);return this.clientCache[n]=o,o}},{key:"_createAwsClient",value:function(e){var t=e.region,n=y.getEndpointOverride(),o="https://participant.connect.".concat(t,".amazonaws.com");return n&&(o=n),new ae({endpoint:o,region:t})}}]),e}(),ae=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Z(e,t)}(n,e);var t=ee(n);function n(e){var o;oe(this,n),o=t.call(this);var r=new AWS.Credentials("",""),i=new AWS.Config({region:e.region,endpoint:e.endpoint,credentials:r});return o.chatClient=new AWS.ConnectParticipant(i),o.invokeUrl=e.endpoint,o.logger=Y.getLogger({prefix:"ChatClient"}),o}return ie(n,[{key:"createParticipantConnection",value:function(e,t){var n=this,o={Type:t,ParticipantToken:e},r=n.chatClient.createParticipantConnection(o);return n._sendRequest(r).then((function(e){return n.logger.info("successfully create connection request"),e})).catch((function(e){return n.logger.error("error when creating connection request"),Promise.reject(e)}))}},{key:"disconnectParticipant",value:function(e){var t=this,n={ConnectionToken:e},o=t.chatClient.disconnectParticipant(n);return t._sendRequest(o).then((function(e){return t.logger.info("successfully disconnect participant"),e})).catch((function(e){return t.logger.error("error when disconnecting participant"),Promise.reject(e)}))}},{key:"getTranscript",value:function(e,t){var n=this,o={MaxResults:t.maxResults,NextToken:t.nextToken,ScanDirection:t.scanDirection,SortOrder:t.sortOrder,StartPosition:{Id:t.startPosition.id,AbsoluteTime:t.startPosition.absoluteTime,MostRecent:t.startPosition.mostRecent},ConnectionToken:e};t.contactId&&(o.ContactId=t.contactId);var r=n.chatClient.getTranscript(o);return console.log("getTranscriptRequest",r),n._sendRequest(r).then((function(e){return n.logger.info("successfully get transcript"),e})).catch((function(e){return n.logger.error("error when getting transcript"),Promise.reject(e)}))}},{key:"sendMessage",value:function(e,t,n){var o=this,r={Content:t,ContentType:n,ConnectionToken:e},i=o.chatClient.sendMessage(r);return o._sendRequest(i).then((function(e){return o.logger.info("successfully send message"),e})).catch((function(e){return o.logger.error("error when sending message"),Promise.reject(e)}))}},{key:"sendAttachment",value:function(e,t,n){var o=this,r={ContentType:t.type,AttachmentName:t.name,AttachmentSizeInBytes:t.size,ConnectionToken:e},i=o.chatClient.startAttachmentUpload(r);return o._sendRequest(i).then((function(n){return o._uploadToS3(t,n.data.UploadMetadata).then((function(){o.logger.info("successfully uploaded attachment");var t={AttachmentIds:[n.data.AttachmentId],ConnectionToken:e},r=o.chatClient.completeAttachmentUpload(t);return o._sendRequest(r)}))})).catch((function(e){return o.logger.error("error when sending attachment"),Promise.reject(e)}))}},{key:"_uploadToS3",value:function(e,t){return fetch(t.Url,{method:"PUT",headers:t.HeadersToInclude,body:e})}},{key:"downloadAttachment",value:function(e,t){var n=this,o={AttachmentId:t,ConnectionToken:e},r=n.chatClient.getAttachment(o);return n._sendRequest(r).then((function(e){return n._downloadUrl(e.data.Url)})).catch((function(e){return n.logger.error("error when sending attachment"),Promise.reject(e)}))}},{key:"_downloadUrl",value:function(e){return fetch(e).then((function(e){return e.blob()})).catch((function(e){return Promise.reject(e)}))}},{key:"sendEvent",value:function(e,t,n){var o=this,r={ConnectionToken:e,ContentType:t,Content:n},i=o.chatClient.sendEvent(r);return o._sendRequest(i).then((function(e){return o.logger.info("successfully send event"),e})).catch((function(e){return o.logger.error("error when sending event"),Promise.reject(e)}))}},{key:"_sendRequest",value:function(e){return new Promise((function(t,n){e.on("success",(function(e){t(e)})).on("error",(function(e){var t={type:e.code,message:e.message,stack:e.stack?e.stack.split("\n"):[]};n(t)})).send()}))}}]),n}(function(){function e(){oe(this,e)}return ie(e,[{key:"sendMessage",value:function(e,t,n){throw new d("sendTextMessage in ChatClient")}},{key:"sendAttachment",value:function(e,t,n){throw new d("sendAttachment in ChatClient")}},{key:"downloadAttachment",value:function(e,t){throw new d("downloadAttachment in ChatClient")}},{key:"disconnectParticipant",value:function(e){throw new d("disconnectParticipant in ChatClient")}},{key:"sendEvent",value:function(e,t,n){throw new d("sendEvent in ChatClient")}},{key:"createParticipantConnection",value:function(e,t){throw new d("createParticipantConnection in ChatClient")}}]),e}()),se=new ce;function ue(e){return(ue="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function le(e,t){return(le=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function fe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=he(e);if(t){var r=he(this).constructor;n=Reflect.construct(o,arguments,r)}else n=o.apply(this,arguments);return pe(this,n)}}function pe(e,t){return!t||"object"!==ue(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function he(e){return(he=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function de(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ge(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function be(e,t,n){return t&&ge(e.prototype,t),n&&ge(e,n),e}var ye=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&le(e,t)}(n,e);var t=fe(n);function n(){return de(this,n),t.apply(this,arguments)}return be(n,[{key:"validateChatDetails",value:function(e,t){if(D.assertIsObject(e,"chatDetails"),t===v.AGENT&&!D.isFunction(e.getConnectionToken))throw new g("getConnectionToken was not a function",e.getConnectionToken);if(D.assertIsNonEmptyString(e.contactId,"chatDetails.contactId"),D.assertIsNonEmptyString(e.participantId,"chatDetails.participantId"),t===v.CUSTOMER){if(!e.participantToken)throw new g("participantToken was not provided for a customer session type",e.participantToken);D.assertIsNonEmptyString(e.participantToken,"chatDetails.participantToken")}}},{key:"validateInitiateChatResponse",value:function(){return!0}},{key:"normalizeChatDetails",value:function(e){var t={};return t.contactId=e.ContactId||e.contactId,t.participantId=e.ParticipantId||e.participantId,t.initialContactId=e.InitialContactId||e.initialContactId||t.contactId||t.ContactId,t.getConnectionToken=e.getConnectionToken||e.GetConnectionToken,(e.participantToken||e.ParticipantToken)&&(t.participantToken=e.ParticipantToken||e.participantToken),this.validateChatDetails(t),t}}]),n}(function(){function e(){de(this,e)}return be(e,[{key:"validateNewControllerDetails",value:function(e){return!0}},{key:"validateSendMessage",value:function(e){if(!D.isString(e.message))throw new g(e.message+"is not a valid message");this.validateContentType(e.contentType)}},{key:"validateContentType",value:function(e){D.assertIsEnum(e,Object.values(_),"contentType")}},{key:"validateConnectChat",value:function(e){return!0}},{key:"validateLogger",value:function(e){D.assertIsObject(e,"logger"),["debug","info","warn","error"].forEach((function(t){if(!D.isFunction(e[t]))throw new g(t+" should be a valid function on the passed logger object!")}))}},{key:"validateSendEvent",value:function(e){this.validateContentType(e.contentType)}},{key:"validateGetMessages",value:function(e){return!0}}]),e}());function ve(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var me="NeverStarted",ke="Starting",we="Connected",Ce="ConnectionLost",Se="Ended",Te="ConnectionLost",_e="ConnectionGained",Ee="Ended",Oe="IncomingMessage",Ie="WEBSOCKET",Ne="CONNECTION_CREDENTIALS",Re=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.connectionDetailsProvider=t,this.isStarted=!1}var t,n,o;return t=e,(n=[{key:"startConnectionTokenPolling",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:432e5;t?this.timeout=setTimeout(this.startConnectionTokenPolling.bind(this),n):this.connectionDetailsProvider.fetchConnectionToken().then((function(){n=e.getTimeToConnectionTokenExpiry(),e.timeout=setTimeout(e.startConnectionTokenPolling.bind(e),n)})).catch((function(t){console.log("An error occurred when attempting to fetch the connection token during Connection Token Polling",t),e.timeout=setTimeout(e.startConnectionTokenPolling.bind(e),n)}))}},{key:"start",value:function(){this.isStarted||(this.isStarted=!0,this.startConnectionTokenPolling(!0,this.getTimeToConnectionTokenExpiry()))}},{key:"end",value:function(){clearTimeout(this.timeout)}},{key:"getConnectionToken",value:function(){return this.connectionDetailsProvider.getFetchedConnectionToken()}},{key:"getConnectionTokenExpiry",value:function(){return this.connectionDetailsProvider.getConnectionTokenExpiry()}},{key:"getTimeToConnectionTokenExpiry",value:function(){return new Date(this.getConnectionTokenExpiry()).getTime()-(new Date).getTime()-6e4}}])&&ve(t.prototype,n),o&&ve(t,o),e}(),Pe=function(e,t,n){this.subMap=e,this.id=D.randomId(),this.eventName=t,this.f=n};Pe.prototype.unsubscribe=function(){this.subMap.unsubscribe(this.eventName,this.id)};var xe=function(){this.subIdMap={},this.subEventNameMap={}};xe.prototype.subscribe=function(e,t){var n=new Pe(this,e,t);this.subIdMap[n.id]=n;var o=this.subEventNameMap[e]||[];return o.push(n),this.subEventNameMap[e]=o,function(){return n.unsubscribe()}},xe.prototype.unsubscribe=function(e,t){D.contains(this.subEventNameMap,e)&&(this.subEventNameMap[e]=this.subEventNameMap[e].filter((function(e){return e.id!==t})),this.subEventNameMap[e].length<1&&delete this.subEventNameMap[e]),D.contains(this.subIdMap,t)&&delete this.subIdMap[t]},xe.prototype.getAllSubscriptions=function(){return D.values(this.subEventNameMap).reduce((function(e,t){return e.concat(t)}),[])},xe.prototype.getSubscriptions=function(e){return this.subEventNameMap[e]||[]};var je=function(e){var t=e||{};this.subMap=new xe,this.logEvents=t.logEvents||!1};function Me(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ae(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}je.prototype.subscribe=function(e,t){return D.assertNotNull(e,"eventName"),D.assertNotNull(t,"f"),D.assertTrue(D.isFunction(t),"f must be a function"),this.subMap.subscribe(e,t)},je.prototype.subscribeAll=function(e){return D.assertNotNull(e,"f"),D.assertTrue(D.isFunction(e),"f must be a function"),this.subMap.subscribe("<<all>>",e)},je.prototype.getSubscriptions=function(e){return this.subMap.getSubscriptions(e)},je.prototype.trigger=function(e,t){D.assertNotNull(e,"eventName");var n=this,o=this.subMap.getSubscriptions("<<all>>"),r=this.subMap.getSubscriptions(e);o.concat(r).forEach((function(o){try{o.f(t||null,e,n)}catch(e){}}))},je.prototype.triggerAsync=function(e,t){var n=this;setTimeout((function(){return n.trigger(e,t)}),0)},je.prototype.bridge=function(){var e=this;return function(t,n){e.trigger(n,t)}},je.prototype.unsubscribeAll=function(){this.subMap.getAllSubscriptions().forEach((function(e){e.unsubscribe()}))};var De=function(){function e(t,n,o){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;Me(this,e),this.chatClient=n,this.participantToken=t||null,this.connectionDetails=null,this.connectionToken=null,this.connectionTokenExpiry=null,this.sessionType=o,this.getConnectionToken=r}var t,n,o;return t=e,(n=[{key:"getFetchedConnectionToken",value:function(){return this.connectionToken}},{key:"getConnectionTokenExpiry",value:function(){return this.connectionTokenExpiry}},{key:"getConnectionDetails",value:function(){return this.connectionDetails}},{key:"fetchConnectionDetails",value:function(){var e=this;return this._fetchConnectionDetails().then((function(){return e.connectionDetails}))}},{key:"fetchConnectionToken",value:function(){var e=this;return this._fetchConnectionDetails().then((function(){return e.connectionToken}))}},{key:"_handleCreateParticipantConnectionResponse",value:function(e){this.connectionDetails={url:e.Websocket.Url,expiry:e.Websocket.ConnectionExpiry,transportLifeTimeInSeconds:3540},this.connectionToken=e.ConnectionCredentials.ConnectionToken,this.connectionTokenExpiry=e.ConnectionCredentials.Expiry}},{key:"_handleGetConnectionTokenResponse",value:function(e){this.connectionDetails={url:null,expiry:null},this.connectionToken=e.participantToken,this.connectionTokenExpiry=e.expiry}},{key:"_callCreateParticipantConnection",value:function(){var e=this;return this.chatClient.createParticipantConnection(this.participantToken,[Ie,Ne]).then((function(t){return e._handleCreateParticipantConnectionResponse(t.data)})).catch((function(e){return Promise.reject({reason:"Failed to fetch connectionDetails with createParticipantConnection",_debug:e})}))}},{key:"_fetchConnectionDetails",value:function(){var e=this;return this.sessionType===v.CUSTOMER?this._callCreateParticipantConnection():this.sessionType===v.AGENT?this.getConnectionToken().then((function(t){return e._handleGetConnectionTokenResponse(t.chatTokenTransport)})).catch((function(){return e._callCreateParticipantConnection()})):Promise.reject({reason:"Failed to fetch connectionDetails.",_debug:new g("Failed to fetch connectionDetails.")})}}])&&Ae(t.prototype,n),o&&Ae(t,o),e}(),Le=n(3);function We(e){return(We="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Fe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ge(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function Be(e,t,n){return t&&Ge(e.prototype,t),n&&Ge(e,n),e}function Ue(e,t,n){return(Ue="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var o=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Xe(e)););return e}(e,t);if(o){var r=Object.getOwnPropertyDescriptor(o,t);return r.get?r.get.call(n):r.value}})(e,t,n||e)}function He(e,t){return(He=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function qe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=Xe(e);if(t){var r=Xe(this).constructor;n=Reflect.construct(o,arguments,r)}else n=o.apply(this,arguments);return ze(this,n)}}function ze(e,t){return!t||"object"!==We(t)&&"function"!=typeof t?Je(e):t}function Je(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Xe(e){return(Xe=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Ve=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&He(e,t)}(n,e);var t=qe(n);function n(e,o,r,i){var c;return Fe(this,n),(c=t.call(this,r)).cleanUpBaseInstance=!i,c.tryCleanup(),n.baseInstance||(n.baseInstance=new $e(r,i)),c.contactId=e,c.initialContactId=o,c.status=null,c.eventBus=new je,c.subscriptions=[n.baseInstance.onEnded(c.handleEnded.bind(Je(c))),n.baseInstance.onConnectionGain(c.handleConnectionGain.bind(Je(c))),n.baseInstance.onConnectionLost(c.handleConnectionLost.bind(Je(c))),n.baseInstance.onMessage(c.handleMessage.bind(Je(c)))],c}return Be(n,[{key:"start",value:function(){return Ue(Xe(n.prototype),"start",this).call(this),n.baseInstance.start()}},{key:"end",value:function(){Ue(Xe(n.prototype),"end",this).call(this),this.eventBus.unsubscribeAll(),this.subscriptions.forEach((function(e){return e()})),this.status=Se,this.tryCleanup()}},{key:"tryCleanup",value:function(){n.baseInstance&&this.cleanUpBaseInstance&&(n.baseInstance.end(),n.baseInstance=null)}},{key:"getStatus",value:function(){return this.status||n.baseInstance.getStatus()}},{key:"onEnded",value:function(e){return this.eventBus.subscribe(Ee,e)}},{key:"handleEnded",value:function(){this.eventBus.trigger(Ee,{})}},{key:"onConnectionGain",value:function(e){return this.eventBus.subscribe(_e,e)}},{key:"handleConnectionGain",value:function(){this.eventBus.trigger(_e,{})}},{key:"onConnectionLost",value:function(e){return this.eventBus.subscribe(Te,e)}},{key:"handleConnectionLost",value:function(){this.eventBus.trigger(Te,{})}},{key:"onMessage",value:function(e){return this.eventBus.subscribe(Oe,e)}},{key:"handleMessage",value:function(e){e.InitialContactId!==this.initialContactId&&e.ContactId!==this.contactId||this.eventBus.trigger(Oe,e)}}]),n}(Re);Ve.baseInstance=null;var $e=function(){function e(t,n){Fe(this,e),this.status=me,this.eventBus=new je,this.logger=Y.getLogger({prefix:"LPC WebSockets: "}),this.initWebsocketManager(n,t)}return Be(e,[{key:"initWebsocketManager",value:function(e,t){this.websocketManager=e||Le.a.create(),this.websocketManager.subscribeTopics(["aws/chat"]),this.subscriptions=[this.websocketManager.onMessage("aws/chat",this.handleMessage.bind(this)),this.websocketManager.onConnectionGain(this.handleConnectionGain.bind(this)),this.websocketManager.onConnectionLost(this.handleConnectionLost.bind(this)),this.websocketManager.onInitFailure(this.handleEnded.bind(this))],e||this.websocketManager.init((function(){return t.fetchConnectionDetails().then((function(e){return{webSocketTransport:{url:e.url,expiry:e.expiry,transportLifeTimeInSeconds:3540}}}))}))}},{key:"end",value:function(){this.websocketManager.closeWebSocket(),this.eventBus.unsubscribeAll(),this.subscriptions.forEach((function(e){return e()}))}},{key:"start",value:function(){return this.status===me&&(this.status=ke),Promise.resolve()}},{key:"onEnded",value:function(e){return this.eventBus.subscribe(Ee,e)}},{key:"handleEnded",value:function(){this.status=Se,this.eventBus.trigger(Ee,{})}},{key:"onConnectionGain",value:function(e){return this.eventBus.subscribe(_e,e)}},{key:"handleConnectionGain",value:function(){this.status=we,this.eventBus.trigger(_e,{})}},{key:"onConnectionLost",value:function(e){return this.eventBus.subscribe(Te,e)}},{key:"handleConnectionLost",value:function(){this.status=Ce,this.eventBus.trigger(Te,{})}},{key:"onMessage",value:function(e){return this.eventBus.subscribe(Oe,e)}},{key:"handleMessage",value:function(e){var t;try{t=JSON.parse(e.content),this.eventBus.trigger(Oe,t)}catch(t){this.logger.error("Wrong message format: ",e)}}},{key:"getStatus",value:function(){return this.status}}]),e}(),Ke=Ve;function Ye(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var Qe="NeverEstablished",Ze="Establishing",et="Established",tt="Broken",nt=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.logger=Y.getLogger({prefix:"ContactId-"+t.chatDetails.contactId+": "}),this.argsValidator=new ye,this.pubsub=new je,this.sessionType=t.sessionType,this.getConnectionToken=t.chatDetails.getConnectionToken,this.connectionDetails=t.chatDetails.connectionDetails,this.initialContactId=t.chatDetails.initialContactId,this.contactId=t.chatDetails.contactId,this.participantId=t.chatDetails.participantId,this.chatClient=t.chatClient,this.participantToken=t.chatDetails.participantToken,this.websocketManager=t.websocketManager,this._participantDisconnected=!1,this.sessionMetadata={}}var t,n,o;return t=e,(n=[{key:"subscribe",value:function(e,t){this.pubsub.subscribe(e,t),this.logger.info("Subscribed successfully to eventName: ",e)}},{key:"handleRequestSuccess",value:function(e,t,n){var o=this;return function(r){return r.metadata=e,o.logger.debug("".concat(n," successful! Response: "),r," / Request: ",t),r}}},{key:"handleRequestFailure",value:function(e,t,n){var o=this;return function(r){return r.metadata=e,o.logger.debug("".concat(n," failed! Error: "),r," / Request: ",t),Promise.reject(r)}}},{key:"sendMessage",value:function(e){var t=e.metadata||null;this.argsValidator.validateSendMessage(e);var n=this.connectionHelper.getConnectionToken();return this.chatClient.sendMessage(n,e.message,e.contentType).then(this.handleRequestSuccess(t,e,"sendMessage")).catch(this.handleRequestFailure(t,e,"sendMessage"))}},{key:"sendAttachment",value:function(e){var t=e.metadata||null,n=this.connectionHelper.getConnectionToken();return this.chatClient.sendAttachment(n,e.attachment,e.metadata).then(this.handleRequestSuccess(t,e,"sendAttachment")).catch(this.handleRequestFailure(t,e,"sendAttachment"))}},{key:"downloadAttachment",value:function(e){var t=e.metadata||null,n=this.connectionHelper.getConnectionToken();return this.chatClient.downloadAttachment(n,e.attachmentId).then(this.handleRequestSuccess(t,e,"downloadAttachment")).catch(this.handleRequestFailure(t,e,"downloadAttachment"))}},{key:"sendEvent",value:function(e){var t=e.metadata||null;this.argsValidator.validateSendEvent(e);var n=this.connectionHelper.getConnectionToken(),o=e.content||null;return this.chatClient.sendEvent(n,e.contentType,o).then(this.handleRequestSuccess(t,e,"sendEvent")).catch(this.handleRequestFailure(t,e,"sendEvent"))}},{key:"getTranscript",value:function(e){if(this.connectionHelper.getStatus()===Se)return Promise.reject("AccessDeniedException");var t=e.metadata||null,n={startPosition:e.startPosition||{},scanDirection:e.scanDirection||I,sortOrder:e.sortOrder||O,maxResults:e.maxResults||E};e.nextToken&&(n.nextToken=e.nextToken),e.contactId&&(n.contactId=e.contactId);var o=this.connectionHelper.getConnectionToken();return this.chatClient.getTranscript(o,n).then(this.handleRequestSuccess(t,n,"getTranscript")).catch(this.handleRequestFailure(t,n,"getTranscript"))}},{key:"connect",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.sessionMetadata=e.metadata||null,this.argsValidator.validateConnectChat(e);var t=this._getConnectionDetailsProvider();return t.fetchConnectionToken().then(this._initConnectionHelper.bind(this,t)).then(this._onConnectSuccess.bind(this),this._onConnectFailure.bind(this))}},{key:"_initConnectionHelper",value:function(e){return this.connectionHelper=new Ke(this.contactId,this.initialContactId,e,this.websocketManager),this.connectionHelper.onEnded(this._handleEndedConnection.bind(this)),this.connectionHelper.onConnectionLost(this._handleLostConnection.bind(this)),this.connectionHelper.onConnectionGain(this._handleGainedConnection.bind(this)),this.connectionHelper.onMessage(this._handleIncomingMessage.bind(this)),this.connectionHelper.start()}},{key:"_getConnectionDetailsProvider",value:function(){return new De(this.participantToken,this.chatClient,this.sessionType,this.getConnectionToken)}},{key:"_handleEndedConnection",value:function(e){this._forwardChatEvent(S,{data:e,chatDetails:this.getChatDetails()})}},{key:"_handleLostConnection",value:function(e){this._forwardChatEvent(C,{data:e,chatDetails:this.getChatDetails()})}},{key:"_handleGainedConnection",value:function(e){this._forwardChatEvent(w,{data:e,chatDetails:this.getChatDetails()})}},{key:"_handleIncomingMessage",value:function(e){try{var t=e.ContentType===_.typing?k:m;this._forwardChatEvent(t,{data:e,chatDetails:this.getChatDetails()}),e.ContentType===_.chatEnded&&(this._forwardChatEvent(T,{data:null,chatDetails:this.getChatDetails()}),this.breakConnection())}catch(t){this.logger.error("Error occured while handling message from Connection. eventData: ",e," Causing exception: ",t)}}},{key:"_forwardChatEvent",value:function(e,t){this.logger.debug("Triggering event for subscribers:",e,t),this.pubsub.triggerAsync(e,t)}},{key:"_onConnectSuccess",value:function(e){this.logger.info("Connect successful!");var t={_debug:e,connectSuccess:!0,connectCalled:!0,metadata:this.sessionMetadata},n=Object.assign({chatDetails:this.getChatDetails()},t);return this.pubsub.triggerAsync(w,n),this._shouldAcknowledgeContact()&&this.sendEvent({contentType:_.connectionAcknowledged}),t}},{key:"_onConnectFailure",value:function(e){var t={_debug:e,connectSuccess:!1,connectCalled:!0,metadata:this.sessionMetadata};return this.logger.error("Connect Failed with data: ",t),Promise.reject(t)}},{key:"_shouldAcknowledgeContact",value:function(){return this.sessionType===v.AGENT}},{key:"breakConnection",value:function(){return this.connectionHelper?this.connectionHelper.end():Promise.resolve()}},{key:"cleanUpOnParticipantDisconnect",value:function(){this.pubsub.unsubscribeAll()}},{key:"disconnectParticipant",value:function(){var e=this,t=this.connectionHelper.getConnectionToken();return this.chatClient.disconnectParticipant(t).then((function(t){return e.logger.info("disconnect participant successful"),e._participantDisconnected=!0,e.cleanUpOnParticipantDisconnect(),e.breakConnection(),t}),(function(t){return e.logger.error("disconnect participant failed with error: ",t),Promise.reject(t)}))}},{key:"getChatDetails",value:function(){return{initialContactId:this.initialContactId,contactId:this.contactId,participantId:this.participantId,participantToken:this.participantToken,connectionDetails:this.connectionDetails}}},{key:"_convertConnectionHelperStatus",value:function(e){switch(e){case me:return Qe;case ke:return Ze;case Se:case Ce:return tt;case we:return et}this.logger.error("Reached invalid state. Unknown connectionHelperStatus: ",e)}},{key:"getConnectionStatus",value:function(){return this._convertConnectionHelperStatus(this.connectionHelper.getStatus())}}])&&Ye(t.prototype,n),o&&Ye(t,o),e}();function ot(e){return(ot="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function rt(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&it(e,t)}function it(e,t){return(it=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ct(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=st(e);if(t){var r=st(this).constructor;n=Reflect.construct(o,arguments,r)}else n=o.apply(this,arguments);return at(this,n)}}function at(e,t){return!t||"object"!==ot(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function st(e){return(st=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ut(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function lt(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function ft(e,t,n){return t&&lt(e.prototype,t),n&&lt(e,n),e}var pt=function(e){rt(n,e);var t=ct(n);function n(){var e;return ut(this,n),(e=t.call(this)).argsValidator=new ye,e}return ft(n,[{key:"createChatSession",value:function(e,t,n,o){var r=this._createChatController(e,t,n,o);if(e===v.AGENT)return new dt(r);if(e===v.CUSTOMER)return new gt(r);throw new g("Unkown value for session type, Allowed values are: "+Object.values(v),e)}},{key:"_createChatController",value:function(e,t,n,o){var r={sessionType:e,chatDetails:this.argsValidator.normalizeChatDetails(t),chatClient:se.getCachedClient(n),websocketManager:o};return new nt(r)}}]),n}(function(){function e(){ut(this,e)}return ft(e,[{key:"createAgentChatController",value:function(e,t){throw new d("createAgentChatController in ChatControllerFactory.")}},{key:"createCustomerChatController",value:function(e,t){throw new d("createCustomerChatController in ChatControllerFactory.")}}]),e}()),ht=function(){function e(t){ut(this,e),this.controller=t}return ft(e,[{key:"onMessage",value:function(e){this.controller.subscribe(m,e)}},{key:"onTyping",value:function(e){this.controller.subscribe(k,e)}},{key:"onConnectionBroken",value:function(e){this.controller.subscribe(S,e)}},{key:"onConnectionEstablished",value:function(e){this.controller.subscribe(w,e)}},{key:"onEnded",value:function(e){this.controller.subscribe(T,e)}},{key:"sendMessage",value:function(e){return this.controller.sendMessage(e)}},{key:"sendAttachment",value:function(e){return this.controller.sendAttachment(e)}},{key:"downloadAttachment",value:function(e){return this.controller.downloadAttachment(e)}},{key:"connect",value:function(e){return this.controller.connect(e)}},{key:"sendEvent",value:function(e){return this.controller.sendEvent(e)}},{key:"getTranscript",value:function(e){return this.controller.getTranscript(e)}},{key:"getChatDetails",value:function(){return this.controller.getChatDetails()}}]),e}(),dt=function(e){rt(n,e);var t=ct(n);function n(e){return ut(this,n),t.call(this,e)}return ft(n,[{key:"cleanUpOnParticipantDisconnect",value:function(){return this.controller.cleanUpOnParticipantDisconnect()}}]),n}(ht),gt=function(e){rt(n,e);var t=ct(n);function n(e){return ut(this,n),t.call(this,e)}return ft(n,[{key:"disconnectParticipant",value:function(){return this.controller.disconnectParticipant()}}]),n}(ht),bt=new pt,yt={create:function(e){var t=e.options||{},n=e.type||v.AGENT;return bt.createChatSession(n,e.chatDetails,t,e.websocketManager)},setGlobalConfig:function(e){var t=e.loggerConfig;y.update(e),Y.updateLoggerConfig(t)},LogLevel:J,Logger:z,SessionTypes:v}},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";(function(e){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.connect=e.connect||{};var o=connect.WebSocketManager;!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==n(e)&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)o.d(r,i,function(t){return e[t]}.bind(null,i));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=2)}([function(e,t,o){var r=o(1),i="DEBUG",c="aws/subscribe",a="aws/heartbeat",s="disconnected";function u(e){return(u="function"==typeof Symbol&&"symbol"==n(Symbol.iterator)?function(e){return n(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":n(e)})(e)}var l={assertTrue:function(e,t){if(!e)throw new Error(t)},assertNotNull:function(e,t){return l.assertTrue(null!==e&&void 0!==u(e),Object(r.sprintf)("%s must be provided",t||"A value")),e},isNonEmptyString:function(e){return"string"==typeof e&&e.length>0},assertIsList:function(e,t){if(!Array.isArray(e))throw new Error(t+" is not an array")},isFunction:function(e){return!!(e&&e.constructor&&e.call&&e.apply)},isObject:function(e){return!("object"!==u(e)||null===e)},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e}},f=new RegExp("^(wss://)\\w*");l.validWSUrl=function(e){return f.test(e)},l.getSubscriptionResponse=function(e,t,n){return{topic:e,content:{status:t?"success":"failure",topics:n}}},l.assertIsObject=function(e,t){if(!l.isObject(e))throw new Error(t+" is not an object!")},l.addJitter=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;t=Math.min(t,1);var n=Math.random()>.5?1:-1;return Math.floor(e+n*e*Math.random()*t)},l.isNetworkOnline=function(){return navigator.onLine},l.isNetworkFailure=function(e){return!(!e._debug||!e._debug.type)&&"NetworkingError"===e._debug.type};var p=l;function h(e){return(h="function"==typeof Symbol&&"symbol"==n(Symbol.iterator)?function(e){return n(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":n(e)})(e)}function d(e){return(d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,t){return(g=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function b(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function y(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function v(e,t,n){return t&&y(e.prototype,t),n&&y(e,n),e}var m=function(){function e(){b(this,e)}return v(e,[{key:"debug",value:function(e){}},{key:"info",value:function(e){}},{key:"warn",value:function(e){}},{key:"error",value:function(e){}}]),e}(),k={DEBUG:10,INFO:20,WARN:30,ERROR:40},w=function(){function e(){b(this,e),this.updateLoggerConfig(),this.consoleLoggerWrapper=T()}return v(e,[{key:"writeToClientLogger",value:function(e,t){if(this.hasClientLogger())switch(e){case k.DEBUG:return this._clientLogger.debug(t);case k.INFO:return this._clientLogger.info(t);case k.WARN:return this._clientLogger.warn(t);case k.ERROR:return this._clientLogger.error(t)}}},{key:"isLevelEnabled",value:function(e){return e>=this._level}},{key:"hasClientLogger",value:function(){return null!==this._clientLogger}},{key:"getLogger",value:function(e){var t=e.prefix||"";return this._logsDestination===i?this.consoleLoggerWrapper:new S(t)}},{key:"updateLoggerConfig",value:function(e){var t=e||{};this._level=t.level||k.DEBUG,this._clientLogger=t.logger||null,this._logsDestination="NULL",t.debug&&(this._logsDestination=i),t.logger&&(this._logsDestination="CLIENT_LOGGER")}}]),e}(),C=function(){function e(){b(this,e)}return v(e,[{key:"debug",value:function(){}},{key:"info",value:function(){}},{key:"warn",value:function(){}},{key:"error",value:function(){}}]),e}(),S=function(e){function t(e){var n;return b(this,t),(n=function(e,t){return!t||"object"!==h(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,d(t).call(this))).prefix=e||"",n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&g(e,t)}(t,C),v(t,[{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return this._log(k.DEBUG,t)}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return this._log(k.INFO,t)}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return this._log(k.WARN,t)}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return this._log(k.ERROR,t)}},{key:"_shouldLog",value:function(e){return _.hasClientLogger()&&_.isLevelEnabled(e)}},{key:"_writeToClientLogger",value:function(e,t){return _.writeToClientLogger(e,t)}},{key:"_log",value:function(e,t){if(this._shouldLog(e)){var n=this._convertToSingleStatement(t);return this._writeToClientLogger(e,n)}}},{key:"_convertToSingleStatement",value:function(e){var t="";this.prefix&&(t+=this.prefix+" ");for(var n=0;n<e.length;n++){var o=e[n];t+=this._convertToString(o)+" "}return t}},{key:"_convertToString",value:function(e){try{if(!e)return"";if(p.isString(e))return e;if(p.isObject(e)&&p.isFunction(e.toString)){var t=e.toString();if("[object Object]"!==t)return t}return JSON.stringify(e)}catch(t){return console.error("Error while converting argument to string",e,t),""}}}]),t}(),T=function(){var e=new C;return e.debug=console.debug,e.info=console.info,e.warn=console.warn,e.error=console.error,e},_=new w;function E(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var O=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2e3;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.numAttempts=0,this.executor=t,this.hasActiveReconnection=!1,this.defaultRetry=n}var t,n;return t=e,(n=[{key:"retry",value:function(){var e=this;this.hasActiveReconnection||(this.hasActiveReconnection=!0,setTimeout((function(){e._execute()}),this._getDelay()))}},{key:"_execute",value:function(){this.hasActiveReconnection=!1,this.executor(),this.numAttempts++}},{key:"connected",value:function(){this.numAttempts=0}},{key:"_getDelay",value:function(){var e=Math.pow(2,this.numAttempts)*this.defaultRetry;return e<=3e4?e:3e4}}])&&E(t.prototype,n),e}();o.d(t,"a",(function(){return N}));var I=function(){var e=_.getLogger({}),t=p.isNetworkOnline(),n={primary:null,secondary:null},o={reconnectWebSocket:!0,websocketInitFailed:!1,exponentialBackOffTime:1e3,exponentialTimeoutHandle:null,lifeTimeTimeoutHandle:null,webSocketInitCheckerTimeoutId:null,connState:null},r={connectWebSocketRetryCount:0,connectionAttemptStartTime:null,noOpenConnectionsTimestamp:null},i={pendingResponse:!1,intervalHandle:null},u={initFailure:new Set,getWebSocketTransport:null,subscriptionUpdate:new Set,subscriptionFailure:new Set,topic:new Map,allMessage:new Set,connectionGain:new Set,connectionLost:new Set,connectionOpen:new Set,connectionClose:new Set},l={connConfig:null,promiseHandle:null,promiseCompleted:!0},f={subscribed:new Set,pending:new Set,subscriptionHistory:new Set},h={responseCheckIntervalId:null,requestCompleted:!0,reSubscribeIntervalId:null,consecutiveFailedSubscribeAttempts:0,consecutiveNoResponseRequest:0},d=new O((function(){B()})),g=new Set([c,"aws/unsubscribe",a]),b=setInterval((function(){if(t!==p.isNetworkOnline()){if(!(t=p.isNetworkOnline()))return void q(e.info("Network offline"));var n=S();t&&(!n||k(n,WebSocket.CLOSING)||k(n,WebSocket.CLOSED))&&(q(e.info("Network online, connecting to WebSocket server")),B())}}),250),y=function(t,n){t.forEach((function(t){try{t(n)}catch(t){q(e.error("Error executing callback",t))}}))},v=function(e){if(null===e)return"NULL";switch(e.readyState){case WebSocket.CONNECTING:return"CONNECTING";case WebSocket.OPEN:return"OPEN";case WebSocket.CLOSING:return"CLOSING";case WebSocket.CLOSED:return"CLOSED";default:return"UNDEFINED"}},m=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";q(e.debug("["+t+"] Primary WebSocket: "+v(n.primary)+" | Secondary WebSocket: "+v(n.secondary)))},k=function(e,t){return e&&e.readyState===t},w=function(e){return k(e,WebSocket.OPEN)},C=function(e){return null===e||void 0===e.readyState||k(e,WebSocket.CLOSED)},S=function(){return null!==n.secondary?n.secondary:n.primary},T=function(){return w(S())},E=function(){if(i.pendingResponse)return q(e.warn("Heartbeat response not received")),clearInterval(i.intervalHandle),i.pendingResponse=!1,void B();T()?(q(e.debug("Sending heartbeat")),S().send(F(a)),i.pendingResponse=!0):(q(e.warn("Failed to send heartbeat since WebSocket is not open")),m("sendHeartBeat"),B())},I=function(){o.exponentialBackOffTime=1e3,i.pendingResponse=!1,o.reconnectWebSocket=!0,clearTimeout(o.lifeTimeTimeoutHandle),clearInterval(i.intervalHandle),clearTimeout(o.exponentialTimeoutHandle),clearTimeout(o.webSocketInitCheckerTimeoutId)},N=function(){h.consecutiveFailedSubscribeAttempts=0,h.consecutiveNoResponseRequest=0,clearInterval(h.responseCheckIntervalId),clearInterval(h.reSubscribeIntervalId)},R=function(){r.connectWebSocketRetryCount=0,r.connectionAttemptStartTime=null,r.noOpenConnectionsTimestamp=null},P=function(){try{q(e.info("WebSocket connection established!")),m("webSocketOnOpen"),null!==o.connState&&o.connState!==s||y(u.connectionGain),o.connState="connected";var t=Date.now();y(u.connectionOpen,{connectWebSocketRetryCount:r.connectWebSocketRetryCount,connectionAttemptStartTime:r.connectionAttemptStartTime,noOpenConnectionsTimestamp:r.noOpenConnectionsTimestamp,connectionEstablishedTime:t,timeToConnect:t-r.connectionAttemptStartTime,timeWithoutConnection:r.noOpenConnectionsTimestamp?t-r.noOpenConnectionsTimestamp:null}),R(),I(),S().openTimestamp=Date.now(),0===f.subscribed.size&&w(n.secondary)&&A(n.primary,"[Primary WebSocket] Closing WebSocket"),(f.subscribed.size>0||f.pending.size>0)&&(w(n.secondary)&&q(e.info("Subscribing secondary websocket to topics of primary websocket")),f.subscribed.forEach((function(e){f.subscriptionHistory.add(e),f.pending.add(e)})),f.subscribed.clear(),M()),E(),i.intervalHandle=setInterval(E,1e4);var c=Math.min(p.addJitter(3e6,.1),1e3*l.connConfig.webSocketTransport.transportLifeTimeInSeconds);q(e.debug("Scheduling WebSocket manager reconnection, after delay "+c+" ms")),o.lifeTimeTimeoutHandle=setTimeout((function(){q(e.debug("Starting scheduled WebSocket manager reconnection")),B()}),c)}catch(t){q(e.error("Error after establishing WebSocket connection",t))}},x=function(t){m("webSocketOnError"),q(e.error("WebSocketManager Error, error_event: ",JSON.stringify(t))),B()},j=function(t){var o=JSON.parse(t.data);switch(o.topic){case c:if(q(e.debug("Subscription Message received from webSocket server",t.data)),h.requestCompleted=!0,h.consecutiveNoResponseRequest=0,"success"===o.content.status)h.consecutiveFailedSubscribeAttempts=0,o.content.topics.forEach((function(e){f.subscriptionHistory.delete(e),f.pending.delete(e),f.subscribed.add(e)})),0===f.subscriptionHistory.size?w(n.secondary)&&(q(e.info("Successfully subscribed secondary websocket to all topics of primary websocket")),A(n.primary,"[Primary WebSocket] Closing WebSocket")):M(),y(u.subscriptionUpdate,o);else{if(clearInterval(h.reSubscribeIntervalId),++h.consecutiveFailedSubscribeAttempts,5===h.consecutiveFailedSubscribeAttempts)return y(u.subscriptionFailure,o),void(h.consecutiveFailedSubscribeAttempts=0);h.reSubscribeIntervalId=setInterval((function(){M()}),500)}break;case a:q(e.debug("Heartbeat response received")),i.pendingResponse=!1;break;default:if(o.topic){if(q(e.debug("Message received for topic "+o.topic)),w(n.primary)&&w(n.secondary)&&0===f.subscriptionHistory.size&&this===n.primary)return void q(e.warn("Ignoring Message for Topic "+o.topic+", to avoid duplicates"));if(0===u.allMessage.size&&0===u.topic.size)return void q(e.warn("No registered callback listener for Topic",o.topic));y(u.allMessage,o),u.topic.has(o.topic)&&y(u.topic.get(o.topic),o)}else o.message?q(e.warn("WebSocketManager Message Error",o)):q(e.warn("Invalid incoming message",o))}},M=function t(){if(h.consecutiveNoResponseRequest>3)return q(e.warn("Ignoring subscribePendingTopics since we have exhausted max subscription retries with no response")),void y(u.subscriptionFailure,p.getSubscriptionResponse(c,!1,Array.from(f.pending)));T()?(clearInterval(h.responseCheckIntervalId),S().send(F(c,{topics:Array.from(f.pending)})),h.requestCompleted=!1,h.responseCheckIntervalId=setInterval((function(){h.requestCompleted||(++h.consecutiveNoResponseRequest,t())}),1e3)):q(e.warn("Ignoring subscribePendingTopics call since Default WebSocket is not open"))},A=function(t,n){k(t,WebSocket.CONNECTING)||k(t,WebSocket.OPEN)?t.close(1e3,n):q(e.warn("Ignoring WebSocket Close request, WebSocket State: "+v(t)))},D=function(e){A(n.primary,"[Primary] WebSocket "+e),A(n.secondary,"[Secondary] WebSocket "+e)},L=function(){r.connectWebSocketRetryCount++;var t=p.addJitter(o.exponentialBackOffTime,.3);Date.now()+t<=l.connConfig.urlConnValidTime?(q(e.debug("Scheduling WebSocket reinitialization, after delay "+t+" ms")),o.exponentialTimeoutHandle=setTimeout((function(){return U()}),t),o.exponentialBackOffTime*=2):(q(e.warn("WebSocket URL cannot be used to establish connection")),B())},W=function(t){I(),N(),q(e.error("WebSocket Initialization failed")),o.websocketInitFailed=!0,D("Terminating WebSocket Manager"),clearInterval(b),y(u.initFailure,{connectWebSocketRetryCount:r.connectWebSocketRetryCount,connectionAttemptStartTime:r.connectionAttemptStartTime,reason:t}),R()},F=function(e,t){return JSON.stringify({topic:e,content:t})},G=function(t){return!!(p.isObject(t)&&p.isObject(t.webSocketTransport)&&p.isNonEmptyString(t.webSocketTransport.url)&&p.validWSUrl(t.webSocketTransport.url)&&1e3*t.webSocketTransport.transportLifeTimeInSeconds>=3e5)||(q(e.error("Invalid WebSocket Connection Configuration",t)),!1)},B=function(){if(p.isNetworkOnline())if(o.websocketInitFailed)q(e.debug("WebSocket Init had failed, ignoring this getWebSocketConnConfig request"));else{if(l.promiseCompleted)return I(),q(e.info("Fetching new WebSocket connection configuration")),r.connectionAttemptStartTime=r.connectionAttemptStartTime||Date.now(),l.promiseCompleted=!1,l.promiseHandle=u.getWebSocketTransport(),l.promiseHandle.then((function(t){return l.promiseCompleted=!0,q(e.debug("Successfully fetched webSocket connection configuration",t)),G(t)?(l.connConfig=t,l.connConfig.urlConnValidTime=Date.now()+85e3,d.connected(),U()):(W("Invalid WebSocket connection configuration: "+t),{webSocketConnectionFailed:!0})}),(function(t){return l.promiseCompleted=!0,q(e.error("Failed to fetch webSocket connection configuration",t)),p.isNetworkFailure(t)&&(q(e.info("Retrying fetching new WebSocket connection configuration")),d.retry()),{webSocketConnectionFailed:!0}}));q(e.debug("There is an ongoing getWebSocketConnConfig request, this request will be ignored"))}else q(e.info("Network offline, ignoring this getWebSocketConnConfig request"))},U=function(){if(o.websocketInitFailed)return q(e.info("web-socket initializing had failed, aborting re-init")),{webSocketConnectionFailed:!0};if(!p.isNetworkOnline())return q(e.warn("System is offline aborting web-socket init")),{webSocketConnectionFailed:!0};q(e.info("Initializing Websocket Manager")),m("initWebSocket");try{if(G(l.connConfig)){var t=null;return w(n.primary)?(q(e.debug("Primary Socket connection is already open")),k(n.secondary,WebSocket.CONNECTING)||(q(e.debug("Establishing a secondary web-socket connection")),n.secondary=H()),t=n.secondary):(k(n.primary,WebSocket.CONNECTING)||(q(e.debug("Establishing a primary web-socket connection")),n.primary=H()),t=n.primary),o.webSocketInitCheckerTimeoutId=setTimeout((function(){w(t)||L()}),1e3),{webSocketConnectionFailed:!1}}}catch(t){return q(e.error("Error Initializing web-socket-manager",t)),W("Failed to initialize new WebSocket: "+t.message),{webSocketConnectionFailed:!0}}},H=function(){var t=new WebSocket(l.connConfig.webSocketTransport.url);return t.addEventListener("open",P),t.addEventListener("message",j),t.addEventListener("error",x),t.addEventListener("close",(function(i){return function(t,i){q(e.info("Socket connection is closed",t)),m("webSocketOnClose before-cleanup"),y(u.connectionClose,{openTimestamp:i.openTimestamp,closeTimestamp:Date.now(),connectionDuration:Date.now()-i.openTimestamp,code:t.code,reason:t.reason}),C(n.primary)&&(n.primary=null),C(n.secondary)&&(n.secondary=null),o.reconnectWebSocket&&(w(n.primary)||w(n.secondary)?C(n.primary)&&w(n.secondary)&&(q(e.info("[Primary] WebSocket Cleanly Closed")),n.primary=n.secondary,n.secondary=null):(q(e.warn("Neither primary websocket and nor secondary websocket have open connections, attempting to re-establish connection")),o.connState===s?q(e.info("Ignoring connectionLost callback invocation")):(y(u.connectionLost,{openTimestamp:i.openTimestamp,closeTimestamp:Date.now(),connectionDuration:Date.now()-i.openTimestamp,code:t.code,reason:t.reason}),r.noOpenConnectionsTimestamp=Date.now()),o.connState=s,B()),m("webSocketOnClose after-cleanup"))}(i,t)})),t},q=function(e){return e&&"function"==typeof e.sendInternalLogToServer&&e.sendInternalLogToServer(),e};this.init=function(t){if(p.assertTrue(p.isFunction(t),"transportHandle must be a function"),null===u.getWebSocketTransport)return u.getWebSocketTransport=t,B();q(e.warn("Web Socket Manager was already initialized"))},this.onInitFailure=function(e){return p.assertTrue(p.isFunction(e),"cb must be a function"),u.initFailure.add(e),o.websocketInitFailed&&e(),function(){return u.initFailure.delete(e)}},this.onConnectionOpen=function(e){return p.assertTrue(p.isFunction(e),"cb must be a function"),u.connectionOpen.add(e),function(){return u.connectionOpen.delete(e)}},this.onConnectionClose=function(e){return p.assertTrue(p.isFunction(e),"cb must be a function"),u.connectionClose.add(e),function(){return u.connectionClose.delete(e)}},this.onConnectionGain=function(e){return p.assertTrue(p.isFunction(e),"cb must be a function"),u.connectionGain.add(e),T()&&e(),function(){return u.connectionGain.delete(e)}},this.onConnectionLost=function(e){return p.assertTrue(p.isFunction(e),"cb must be a function"),u.connectionLost.add(e),o.connState===s&&e(),function(){return u.connectionLost.delete(e)}},this.onSubscriptionUpdate=function(e){return p.assertTrue(p.isFunction(e),"cb must be a function"),u.subscriptionUpdate.add(e),function(){return u.subscriptionUpdate.delete(e)}},this.onSubscriptionFailure=function(e){return p.assertTrue(p.isFunction(e),"cb must be a function"),u.subscriptionFailure.add(e),function(){return u.subscriptionFailure.delete(e)}},this.onMessage=function(e,t){return p.assertNotNull(e,"topicName"),p.assertTrue(p.isFunction(t),"cb must be a function"),u.topic.has(e)?u.topic.get(e).add(t):u.topic.set(e,new Set([t])),function(){return u.topic.get(e).delete(t)}},this.onAllMessage=function(e){return p.assertTrue(p.isFunction(e),"cb must be a function"),u.allMessage.add(e),function(){return u.allMessage.delete(e)}},this.subscribeTopics=function(e){p.assertNotNull(e,"topics"),p.assertIsList(e),e.forEach((function(e){f.subscribed.has(e)||f.pending.add(e)})),h.consecutiveNoResponseRequest=0,M()},this.sendMessage=function(t){if(p.assertIsObject(t,"payload"),void 0===t.topic||g.has(t.topic))q(e.warn("Cannot send message, Invalid topic",t));else{try{t=JSON.stringify(t)}catch(n){return void q(e.warn("Error stringify message",t))}T()?S().send(t):q(e.warn("Cannot send message, web socket connection is not open"))}},this.closeWebSocket=function(){I(),N(),o.reconnectWebSocket=!1,clearInterval(b),D("User request to close WebSocket")},this.terminateWebSocketManager=W},N={create:function(){return new I},setGlobalConfig:function(e){var t=e.loggerConfig;_.updateLoggerConfig(t)},LogLevel:k,Logger:m}},function(e,t,o){var r;!function(){var i={not_string:/[^s]/,not_bool:/[^t]/,not_type:/[^T]/,not_primitive:/[^v]/,number:/[diefg]/,numeric_arg:/[bcdiefguxX]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijostTuvxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[+-]/};function c(e){return function(e,t){var o,r,a,s,u,l,f,p,h,d=1,g=e.length,b="";for(r=0;r<g;r++)if("string"==typeof e[r])b+=e[r];else if("object"==n(e[r])){if((s=e[r]).keys)for(o=t[d],a=0;a<s.keys.length;a++){if(null==o)throw new Error(c('[sprintf] Cannot access property "%s" of undefined value "%s"',s.keys[a],s.keys[a-1]));o=o[s.keys[a]]}else o=s.param_no?t[s.param_no]:t[d++];if(i.not_type.test(s.type)&&i.not_primitive.test(s.type)&&o instanceof Function&&(o=o()),i.numeric_arg.test(s.type)&&"number"!=typeof o&&isNaN(o))throw new TypeError(c("[sprintf] expecting number but found %T",o));switch(i.number.test(s.type)&&(p=o>=0),s.type){case"b":o=parseInt(o,10).toString(2);break;case"c":o=String.fromCharCode(parseInt(o,10));break;case"d":case"i":o=parseInt(o,10);break;case"j":o=JSON.stringify(o,null,s.width?parseInt(s.width):0);break;case"e":o=s.precision?parseFloat(o).toExponential(s.precision):parseFloat(o).toExponential();break;case"f":o=s.precision?parseFloat(o).toFixed(s.precision):parseFloat(o);break;case"g":o=s.precision?String(Number(o.toPrecision(s.precision))):parseFloat(o);break;case"o":o=(parseInt(o,10)>>>0).toString(8);break;case"s":o=String(o),o=s.precision?o.substring(0,s.precision):o;break;case"t":o=String(!!o),o=s.precision?o.substring(0,s.precision):o;break;case"T":o=Object.prototype.toString.call(o).slice(8,-1).toLowerCase(),o=s.precision?o.substring(0,s.precision):o;break;case"u":o=parseInt(o,10)>>>0;break;case"v":o=o.valueOf(),o=s.precision?o.substring(0,s.precision):o;break;case"x":o=(parseInt(o,10)>>>0).toString(16);break;case"X":o=(parseInt(o,10)>>>0).toString(16).toUpperCase()}i.json.test(s.type)?b+=o:(!i.number.test(s.type)||p&&!s.sign?h="":(h=p?"+":"-",o=o.toString().replace(i.sign,"")),l=s.pad_char?"0"===s.pad_char?"0":s.pad_char.charAt(1):" ",f=s.width-(h+o).length,u=s.width&&f>0?l.repeat(f):"",b+=s.align?h+o+u:"0"===l?h+u+o:u+h+o)}return b}(function(e){if(s[e])return s[e];for(var t,n=e,o=[],r=0;n;){if(null!==(t=i.text.exec(n)))o.push(t[0]);else if(null!==(t=i.modulo.exec(n)))o.push("%");else{if(null===(t=i.placeholder.exec(n)))throw new SyntaxError("[sprintf] unexpected placeholder");if(t[2]){r|=1;var c=[],a=t[2],u=[];if(null===(u=i.key.exec(a)))throw new SyntaxError("[sprintf] failed to parse named argument key");for(c.push(u[1]);""!==(a=a.substring(u[0].length));)if(null!==(u=i.key_access.exec(a)))c.push(u[1]);else{if(null===(u=i.index_access.exec(a)))throw new SyntaxError("[sprintf] failed to parse named argument key");c.push(u[1])}t[2]=c}else r|=2;if(3===r)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");o.push({placeholder:t[0],param_no:t[1],keys:t[2],sign:t[3],pad_char:t[4],align:t[5],width:t[6],precision:t[7],type:t[8]})}n=n.substring(t[0].length)}return s[e]=o}(e),arguments)}function a(e,t){return c.apply(null,[e].concat(t||[]))}var s=Object.create(null);t.sprintf=c,t.vsprintf=a,"undefined"!=typeof window&&(window.sprintf=c,window.vsprintf=a,void 0===(r=function(){return{sprintf:c,vsprintf:a}}.call(t,o,t,e))||(e.exports=r))}()},function(e,t,n){n.r(t),function(e){n.d(t,"WebSocketManager",(function(){return r}));var o=n(0);e.connect=e.connect||{},connect.WebSocketManager=o.a;var r=o.a}.call(this,n(3))},function(e,t){var o;o=function(){return this}();try{o=o||new Function("return this")()}catch(e){"object"==("undefined"==typeof window?"undefined":n(window))&&(o=window)}e.exports=o}]);var r=connect.WebSocketManager;connect.WebSocketManager=o||r,t.a=r}).call(this,n(2))},function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"ChatSession",(function(){return r}));var o=n(1);e.connect=e.connect||{},connect.ChatSession=o.a;var r=o.a}.call(this,n(2))}]);
//# sourceMappingURL=amazon-connect-chat.js.map